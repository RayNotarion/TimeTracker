<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Time Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <style>
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: scale(0.9);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }
      .animate-fadeIn {
        animation: fadeIn 0.3s ease-out;
      }
      
      @keyframes pulse-glow {
        0%, 100% {
          box-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
        }
        50% {
          box-shadow: 0 0 40px rgba(239, 68, 68, 0.8);
        }
      }
      
      .pulse-glow {
        animation: pulse-glow 2s ease-in-out infinite;
      }
      
      /* Custom scrollbar */
      ::-webkit-scrollbar {
        width: 10px;
        height: 10px;
      }
      ::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
      }
      ::-webkit-scrollbar-thumb {
        background: linear-gradient(to bottom, #6366f1, #a855f7);
        border-radius: 10px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(to bottom, #4f46e5, #9333ea);
      }
    </style>
  </head>

  <body class="bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 min-h-screen p-6 pt-0">
    <header
      class="sticky r-2 top-0 z-50 bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600 flex justify-between items-center mb-8 p-6 shadow-2xl rounded-2xl backdrop-blur-lg"
    >
      <h1 class="text-4xl font-bold text-white flex items-center gap-3">
        <i class="fa-solid fa-clock animate-pulse"></i> Time Tracker
      </h1>
      <div class="flex items-center gap-4">
        <button
          onclick="switchMode()"
          id="switchModeBtn"
          class="bg-white/20 backdrop-blur-md hover:bg-white/30 text-white px-6 py-2.5 rounded-xl flex items-center gap-2 transition-all duration-300 transform hover:scale-105 border border-white/30"
        >
          <i class="fa-solid fa-repeat"></i> <span id="switchModeText">Switch Mode</span>
        </button>
        <button
          onclick="logoutUser()"
          class="bg-white/20 backdrop-blur-md hover:bg-white/30 text-white px-6 py-2.5 rounded-xl flex items-center gap-2 transition-all duration-300 transform hover:scale-105 border border-white/30"
        >
          <i class="fa-solid fa-right-from-bracket"></i> Logout
        </button>
      </div>
    </header>

    <div class="bg-white/90 backdrop-blur-xl shadow-2xl rounded-3xl w-full max-w-6xl mx-auto p-8 border border-white/20">
      <!-- View Button -->
      <div class="flex gap-3 mb-8">
        <button
          onclick="openHistoryModal()"
          class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-2xl px-8 py-4 font-bold text-lg hover:from-purple-700 hover:to-indigo-700 transition-all duration-300 transform hover:scale-105 flex items-center justify-center gap-3 shadow-lg hover:shadow-2xl"
        >
          <i class="fa-solid fa-clock-rotate-left text-xl"></i> View History
        </button>
      </div>

      <!-- Realtime Tracking Section -->
      <div id="realtimeSection" class="hidden mb-8">
        <div class="bg-gradient-to-r from-indigo-50 via-purple-50 to-pink-50 p-8 rounded-2xl border-2 border-indigo-200 shadow-lg">
          <div class="text-center mb-6">
            <h2 class="text-3xl font-black bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent mb-2">
              Realtime Tracking
            </h2>
            <p class="text-gray-600 font-medium">Track your time as it happens</p>
          </div>
          
          <div class="flex flex-col items-center gap-6">
            <div class="text-center">
              <div id="realtimeDisplay" class="text-6xl font-black bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent mb-2">
                00:00:00
              </div>
              <div id="realtimeDate" class="text-lg text-gray-600 font-medium"></div>
            </div>
            
            <div class="w-full max-w-md">
              <div class="relative group">
                <i class="fa-solid fa-note-sticky absolute left-4 top-4 text-indigo-400 group-focus-within:text-indigo-600 transition-colors"></i>
                <textarea
                  id="realtimeNote"
                  placeholder="Add a note about this task (optional)"
                  rows="3"
                  class="w-full border-2 border-gray-200 rounded-xl pl-12 pr-4 py-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all duration-300 bg-gray-50 hover:bg-white resize-none"
                ></textarea>
              </div>
            </div>
            
            <div class="flex gap-4">
              <button
                id="startBtn"
                onclick="startRealtime()"
                class="bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white px-10 py-4 rounded-2xl font-bold text-lg transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-xl flex items-center gap-3"
              >
                <i class="fa-solid fa-play text-xl"></i> Start
              </button>
              
              <button
                id="stopBtn"
                onclick="stopRealtime()"
                disabled
                class="bg-gradient-to-r from-red-500 to-pink-600 hover:from-red-600 hover:to-pink-700 text-white px-10 py-4 rounded-2xl font-bold text-lg transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-xl flex items-center gap-3 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100"
              >
                <i class="fa-solid fa-stop text-xl"></i> Stop
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Manual Input Section -->
      <div id="manualSection" class="hidden">
        <div class="flex gap-3 mb-8 justify-start">
          <button
            onclick="openAddEntryModal()"
            class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-xl px-8 py-4 font-bold text-lg hover:from-indigo-700 hover:to-purple-700 transition-all duration-300 transform hover:scale-105 flex items-center justify-center gap-2 shadow-lg hover:shadow-xl"
          >
            <i class="fa-solid fa-plus text-xl"></i> Add Entry
          </button>

          <button
            onclick="deleteAllEntries()"
            class="bg-gradient-to-r from-red-500 to-pink-600 text-white rounded-xl px-8 py-4 font-bold text-lg hover:from-red-600 hover:to-pink-700 transition-all duration-300 transform hover:scale-105 flex items-center justify-center gap-2 shadow-lg hover:shadow-xl"
          >
            <i class="fa-solid fa-trash-can text-xl"></i> Delete All
          </button>
        </div>
      </div>

      <div class="overflow-x-auto rounded-2xl border-2 border-gray-100 mb-8 shadow-lg">
        <table class="w-full border-collapse">
          <thead>
            <tr class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white">
              <th class="p-5 text-left font-bold text-sm uppercase tracking-wider">Date</th>
              <th class="p-5 text-left font-bold text-sm uppercase tracking-wider">Start</th>
              <th class="p-5 text-left font-bold text-sm uppercase tracking-wider">End</th>
              <th class="p-5 text-left font-bold text-sm uppercase tracking-wider">Duration</th>
              <th class="p-5 text-center font-bold text-sm uppercase tracking-wider">Action</th>
            </tr>
          </thead>
          <tbody id="list" class="divide-y divide-gray-100"></tbody>
        </table>
      </div>

      <div class="flex justify-between items-center bg-gradient-to-r from-indigo-50 via-purple-50 to-pink-50 p-6 rounded-2xl border-2 border-indigo-100 shadow-lg">
        <span class="font-bold text-indigo-700 text-2xl flex items-center gap-3">
          <i class="fa-solid fa-chart-pie text-3xl"></i> Total Time This Month
        </span>
        <span id="total" class="text-4xl font-black bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">0h 0m</span>
      </div>

      <!-- Export Button -->
      <div class="mt-6 flex justify-center">
        <button
          onclick="exportToCSV()"
          class="bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white px-8 py-4 rounded-2xl flex items-center gap-3 font-bold transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-xl"
        >
          <i class="fa-solid fa-file-export text-xl"></i> Export to CSV
        </button>
      </div>
    </div>

<!-- Mode Selection Modal -->
<div id="modeSelectionModal" class="fixed inset-0 bg-black/70 backdrop-blur-md z-[10000] hidden flex items-center justify-center p-4">
  <div class="bg-white rounded-3xl shadow-2xl w-full max-w-2xl overflow-hidden animate-fadeIn">
    <div class="bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600 p-8 text-center">
      <i class="fa-solid fa-clock text-6xl text-white mb-4"></i>
      <h2 class="text-3xl font-black text-white">Choose Your Tracking Mode</h2>
      <p class="text-white/90 mt-2">Select how you want to track your time</p>
    </div>
    
    <div class="p-8 grid grid-cols-1 md:grid-cols-2 gap-6">
      <button
        onclick="selectMode('realtime')"
        class="group bg-gradient-to-br from-green-50 to-emerald-50 hover:from-green-100 hover:to-emerald-100 border-2 border-green-200 hover:border-green-400 rounded-2xl p-8 transition-all duration-300 transform hover:scale-105 hover:shadow-xl"
      >
        <div class="text-center">
          <i class="fa-solid fa-stopwatch text-6xl text-green-600 group-hover:text-green-700 mb-4"></i>
          <h3 class="text-2xl font-bold text-gray-800 mb-2">Realtime Tracking</h3>
          <p class="text-gray-600 text-sm">Start and stop timer as you work</p>
        </div>
      </button>
      
      <button
        onclick="selectMode('manual')"
        class="group bg-gradient-to-br from-indigo-50 to-purple-50 hover:from-indigo-100 hover:to-purple-100 border-2 border-indigo-200 hover:border-indigo-400 rounded-2xl p-8 transition-all duration-300 transform hover:scale-105 hover:shadow-xl"
      >
        <div class="text-center">
          <i class="fa-solid fa-keyboard text-6xl text-indigo-600 group-hover:text-indigo-700 mb-4"></i>
          <h3 class="text-2xl font-bold text-gray-800 mb-2">Manual Input</h3>
          <p class="text-gray-600 text-sm">Enter start and end times manually</p>
        </div>
      </button>
    </div>
  </div>
</div>

<!-- History Modal -->
<div id="historyModal" class="fixed inset-0 bg-black/60 backdrop-blur-md z-[9999] hidden flex items-center justify-center p-4">
  <div class="bg-white rounded-3xl shadow-2xl w-full max-w-6xl max-h-[90vh] overflow-hidden flex flex-col animate-fadeIn">
    <!-- Modal Header -->
    <div class="bg-gradient-to-r from-purple-600 via-indigo-600 to-pink-600 p-8 flex justify-between items-center">
      <h2 class="text-3xl font-black text-white flex items-center gap-3">
        <i class="fa-solid fa-clock-rotate-left text-4xl"></i> History
      </h2>
      <button onclick="closeHistoryModal()" class="text-white hover:text-gray-200 text-3xl transition-transform hover:rotate-90 duration-300">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>

    <!-- Filter Section -->
    <div class="p-6 bg-gradient-to-r from-purple-50 via-indigo-50 to-pink-50 border-b-2 border-indigo-100">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label class="block text-sm font-bold text-indigo-700 mb-2 uppercase tracking-wide">Month</label>
          <select id="modalFilterMonth" onchange="applyModalFilter()" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all bg-white">
            <option value="">All Months</option>
            <option value="0">January</option>
            <option value="1">February</option>
            <option value="2">March</option>
            <option value="3">April</option>
            <option value="4">May</option>
            <option value="5">June</option>
            <option value="6">July</option>
            <option value="7">August</option>
            <option value="8">September</option>
            <option value="9">October</option>
            <option value="10">November</option>
            <option value="11">December</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-bold text-indigo-700 mb-2 uppercase tracking-wide">Year</label>
          <select id="modalFilterYear" onchange="applyModalFilter()" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all bg-white">
            <option value="">All Years</option>
          </select>
        </div>
        <div class="flex items-end">
          <button onclick="clearModalFilter()" class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-xl px-4 py-3 font-bold hover:from-purple-700 hover:to-indigo-700 transition-all duration-300 transform hover:scale-105 shadow-lg">
            <i class="fa-solid fa-filter-circle-xmark"></i> Clear Filter
          </button>
        </div>
      </div>
    </div>

    <!-- Modal Body -->
    <div class="flex-1 overflow-auto p-6 bg-gray-50">
      <div class="overflow-x-auto rounded-2xl border-2 border-gray-100 mb-4 shadow-lg bg-white">
        <table class="w-full border-collapse">
          <thead>
            <tr class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white">
              <th class="p-5 text-left font-bold text-sm uppercase tracking-wider">Date</th>
              <th class="p-5 text-left font-bold text-sm uppercase tracking-wider">Start</th>
              <th class="p-5 text-left font-bold text-sm uppercase tracking-wider">End</th>
              <th class="p-5 text-left font-bold text-sm uppercase tracking-wider">Duration</th>
              <th class="p-5 text-left font-bold text-sm uppercase tracking-wider">Note</th>
            </tr>
          </thead>
          <tbody id="historyList" class="divide-y divide-gray-100"></tbody>
        </table>
      </div>

      <div class="flex justify-between items-center bg-gradient-to-r from-indigo-50 via-purple-50 to-pink-50 p-6 rounded-2xl border-2 border-indigo-100 shadow-lg">
        <span class="font-bold text-indigo-700 text-2xl flex items-center gap-3">
          <i class="fa-solid fa-chart-pie text-3xl"></i> Total Time
        </span>
        <span id="historyTotal" class="text-4xl font-black bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">0h 0m</span>
      </div>
    </div>

    <!-- Modal Footer -->
    <div class="p-6 bg-gradient-to-r from-gray-50 to-gray-100 border-t-2 border-gray-200 flex justify-end">
      <button onclick="exportHistoryToCSV()" class="bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white px-8 py-4 rounded-2xl flex items-center gap-3 font-bold transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-xl">
        <i class="fa-solid fa-file-export text-xl"></i> Export to CSV
      </button>
    </div>
  </div>
</div>

<!-- Note View Modal -->
<div id="noteModal" class="fixed inset-0 bg-black/60 backdrop-blur-md z-[10001] hidden flex items-center justify-center p-4">
  <div class="bg-white rounded-3xl shadow-2xl w-full max-w-2xl overflow-hidden animate-fadeIn">
    <div class="bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600 p-8 flex justify-between items-center">
      <h2 class="text-3xl font-black text-white flex items-center gap-3">
        <i class="fa-solid fa-note-sticky text-4xl"></i> Task Note
      </h2>
      <button onclick="closeNoteModal()" class="text-white hover:text-gray-200 text-3xl transition-transform hover:rotate-90 duration-300">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>
    
    <div class="p-8">
      <div class="mb-6">
        <h3 class="text-sm font-bold text-indigo-700 uppercase tracking-wide mb-2">Entry Details</h3>
        <div class="bg-gradient-to-r from-indigo-50 to-purple-50 p-4 rounded-xl">
          <p class="text-gray-700"><strong>Date:</strong> <span id="noteModalDate"></span></p>
          <p class="text-gray-700"><strong>Time:</strong> <span id="noteModalTime"></span></p>
          <p class="text-gray-700"><strong>Duration:</strong> <span id="noteModalDuration"></span></p>
        </div>
      </div>
      
      <div>
        <h3 class="text-sm font-bold text-indigo-700 uppercase tracking-wide mb-2">Note</h3>
        <div class="bg-gray-50 p-6 rounded-xl border-2 border-gray-200 min-h-[150px]">
          <p id="noteModalContent" class="text-gray-700 whitespace-pre-wrap"></p>
        </div>
      </div>
    </div>
    
    <div class="p-6 bg-gradient-to-r from-gray-50 to-gray-100 border-t-2 border-gray-200 flex justify-end">
      <button onclick="closeNoteModal()" class="bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white px-8 py-4 rounded-2xl font-bold transition-all duration-300 transform hover:scale-105 shadow-lg">
        Close
      </button>
    </div>
  </div>
</div>

<!-- Add Entry Modal -->
<div id="addEntryModal" class="fixed inset-0 bg-black/60 backdrop-blur-md z-[10001] hidden flex items-center justify-center p-4">
  <div class="bg-white rounded-3xl shadow-2xl w-full max-w-2xl overflow-hidden animate-fadeIn">
    <div class="bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600 p-8 flex justify-between items-center">
      <h2 class="text-3xl font-black text-white flex items-center gap-3">
        <i class="fa-solid fa-plus-circle text-4xl"></i> Add Time Entry
      </h2>
      <button onclick="closeAddEntryModal()" class="text-white hover:text-gray-200 text-3xl transition-transform hover:rotate-90 duration-300">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>
    
    <div class="p-8">
      <div class="space-y-6">
        <div>
          <label class="block text-sm font-bold text-indigo-700 mb-2 uppercase tracking-wide">Date</label>
          <div class="relative group">
            <i class="fa-solid fa-calendar-day absolute left-4 top-1/2 -translate-y-1/2 text-indigo-400 group-focus-within:text-indigo-600 transition-colors"></i>
            <input
              id="modalDate"
              type="date"
              class="w-full border-2 border-gray-200 rounded-xl pl-12 pr-4 py-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all duration-300 bg-gray-50 hover:bg-white"
            />
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-bold text-indigo-700 mb-2 uppercase tracking-wide">Start Time</label>
            <div class="relative group">
              <i class="fa-solid fa-play absolute left-4 top-1/2 -translate-y-1/2 text-indigo-400 group-focus-within:text-indigo-600 transition-colors"></i>
              <input
                id="modalStart"
                type="text"
                placeholder="Start Time"
                class="w-full border-2 border-gray-200 rounded-xl pl-12 pr-4 py-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all duration-300 bg-gray-50 hover:bg-white"
              />
            </div>
          </div>

          <div>
            <label class="block text-sm font-bold text-indigo-700 mb-2 uppercase tracking-wide">End Time</label>
            <div class="relative group">
              <i class="fa-solid fa-stop absolute left-4 top-1/2 -translate-y-1/2 text-indigo-400 group-focus-within:text-indigo-600 transition-colors"></i>
              <input
                id="modalEnd"
                type="text"
                placeholder="End Time"
                class="w-full border-2 border-gray-200 rounded-xl pl-12 pr-4 py-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all duration-300 bg-gray-50 hover:bg-white"
              />
            </div>
          </div>
        </div>

        <div>
          <label class="block text-sm font-bold text-indigo-700 mb-2 uppercase tracking-wide">Note (Optional)</label>
          <div class="relative group">
            <i class="fa-solid fa-note-sticky absolute left-4 top-4 text-indigo-400 group-focus-within:text-indigo-600 transition-colors"></i>
            <textarea
              id="modalNote"
              placeholder="Add a note about this task"
              rows="4"
              class="w-full border-2 border-gray-200 rounded-xl pl-12 pr-4 py-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all duration-300 bg-gray-50 hover:bg-white resize-none"
            ></textarea>
          </div>
        </div>
      </div>
    </div>
    
    <div class="p-6 bg-gradient-to-r from-gray-50 to-gray-100 border-t-2 border-gray-200 flex justify-end gap-3">
      <button onclick="closeAddEntryModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-8 py-4 rounded-2xl font-bold transition-all duration-300 transform hover:scale-105 shadow-lg">
        Cancel
      </button>
      <button onclick="saveManualEntry()" class="bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white px-8 py-4 rounded-2xl font-bold transition-all duration-300 transform hover:scale-105 shadow-lg">
        <i class="fa-solid fa-check"></i> Save Entry
      </button>
    </div>
  </div>
</div>


    <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
  import {
    getFirestore,
    collection,
    addDoc,
    getDocs,
    deleteDoc,
    doc,
    query,
    where,
    writeBatch,
    updateDoc,
    setDoc,
    getDoc,
  } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
  import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCOtKE4gJCtq4PKcjyoWveYgbDmUMpBa-w",
    authDomain: "timetrackersystem-6cacf.firebaseapp.com",
    projectId: "timetrackersystem-6cacf",
    storageBucket: "timetrackersystem-6cacf.firebasestorage.app",
    messagingSenderId: "1053438003292",
    appId: "1:1053438003292:web:86a6ff9fa12cf819f2fe99",
    measurementId: "G-FYKGKY1BTY",
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  let user = null;
  let entries = [];
  let allEntries = [];
  let historyEntries = [];
  let totalMinutes = 0;
  let currentMode = null;
  
  // Realtime tracking variables
  let realtimeInterval = null;
  let realtimeStartTime = null;
  let realtimeStartDate = null;

  const timeCollection = collection(db, "timeEntries");
  const userPrefsCollection = collection(db, "userPreferences");

  // ------------------ Formatting Functions ------------------
  function formatTime(time) {
    if (time.toUpperCase().includes("AM") || time.toUpperCase().includes("PM")) return time;
    const [hour, minute] = time.split(":").map(Number);
    const ampm = hour >= 12 ? "PM" : "AM";
    const hour12 = hour % 12 || 12;
    return `${hour12}:${minute.toString().padStart(2, "0")} ${ampm}`;
  }

  function formatDate(date) {
    return new Date(date).toLocaleDateString("en-US", {
      year: "numeric",
      month: "short",
      day: "numeric",
    });
  }

  function showEmptyMessage() {
    document.getElementById("list").innerHTML = `
      <tr>
        <td colspan="5" class="p-12 text-center text-gray-400">
          <i class="fa-solid fa-clock text-6xl mb-4 block text-indigo-200"></i>
          <p class="text-xl font-semibold text-gray-500">No time entries yet</p>
          <p class="text-sm text-gray-400 mt-2">Add your first entry above to get started</p>
        </td>
      </tr>
    `;
  }

  function addRow(entry, index) {
    const row = `
      <tr class="hover:bg-gradient-to-r hover:from-indigo-50 hover:to-purple-50 transition-all duration-200 group">
        <td class="p-5 text-gray-700 font-medium">${formatDate(entry.date)}</td>
        <td class="p-5 text-gray-600">${formatTime(entry.start)}</td>
        <td class="p-5 text-gray-600">${formatTime(entry.end)}</td>
        <td class="p-5 font-bold text-lg bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">${entry.hours}h ${entry.minutes}m</td>
        <td class="p-5 text-center">
          <button onclick="viewNote(${index})" class="text-indigo-500 hover:text-indigo-700 transition-all duration-200 transform hover:scale-110 mr-3">
            <i class="fa-solid fa-eye text-xl"></i>
          </button>
          <button onclick="deleteEntry(${index})" class="text-red-500 hover:text-red-700 transition-all duration-200 transform hover:scale-125 hover:rotate-12">
            <i class="fa-solid fa-trash text-xl"></i>
          </button>
        </td>
      </tr>
    `;
    document.getElementById("list").insertAdjacentHTML("beforeend", row);
  }

  function refreshTable() {
    document.getElementById("list").innerHTML = "";
    if (entries.length === 0) {
      showEmptyMessage();
      return;
    }
    entries.forEach((entry, index) => addRow(entry, index));
  }

  function updateTotal() {
    const h = Math.floor(totalMinutes / 60);
    const m = totalMinutes % 60;
    document.getElementById("total").textContent = `${h}h ${m}m`;
  }

  function isThisMonth(dateString) {
    const entryDate = new Date(dateString);
    const now = new Date();
    return entryDate.getMonth() === now.getMonth() && 
           entryDate.getFullYear() === now.getFullYear();
  }

  function filterThisMonthEntries() {
    entries = allEntries.filter(entry => isThisMonth(entry.date));
    totalMinutes = entries.reduce((sum, entry) => sum + entry.minutesTotal, 0);
    refreshTable();
    updateTotal();
  }

  async function loadFromFirestore() {
    showLoading();

    try {
      allEntries = [];
      entries = [];
      totalMinutes = 0;

      const q = query(timeCollection, where("uid", "==", user.uid));
      const querySnapshot = await getDocs(q);

      querySnapshot.forEach((docSnap) => {
        const data = docSnap.data();
        allEntries.push({ ...data, id: docSnap.id });
      });

      filterThisMonthEntries();
    } catch (error) {
      Swal.fire({
        icon: "error",
        title: "Failed to load entries",
        text: error.message,
      });
    } finally {
      hideLoading();
    }
  }

  // ------------------ Mode Selection Functions ------------------
  async function loadUserPreference() {
    try {
      const prefDoc = await getDoc(doc(userPrefsCollection, user.uid));
      if (prefDoc.exists()) {
        const mode = prefDoc.data().trackingMode;
        if (mode) {
          setMode(mode);
          return;
        }
      }
      // Show mode selection if no preference exists
      showModeSelection();
    } catch (error) {
      console.error("Error loading preference:", error);
      showModeSelection();
    }
  }

  function showModeSelection() {
    document.getElementById("modeSelectionModal").classList.remove("hidden");
  }

  async function saveUserPreference(mode) {
    try {
      await setDoc(doc(userPrefsCollection, user.uid), {
        trackingMode: mode,
        uid: user.uid,
      });
    } catch (error) {
      console.error("Error saving preference:", error);
    }
  }

  window.selectMode = async function(mode) {
    document.getElementById("modeSelectionModal").classList.add("hidden");
    await saveUserPreference(mode);
    setMode(mode);
  };

  function setMode(mode) {
    currentMode = mode;
    
    if (mode === 'realtime') {
      document.getElementById("realtimeSection").classList.remove("hidden");
      document.getElementById("manualSection").classList.add("hidden");
      updateRealtimeDate();
    } else {
      document.getElementById("realtimeSection").classList.add("hidden");
      document.getElementById("manualSection").classList.remove("hidden");
    }
  }

  window.switchMode = async function() {
    const result = await Swal.fire({
      title: "Switch Tracking Mode?",
      text: "Choose your new tracking mode",
      icon: "question",
      showCancelButton: true,
      confirmButtonText: currentMode === 'realtime' ? 'Switch to Manual' : 'Switch to Realtime',
      cancelButtonText: 'Cancel',
      confirmButtonColor: "#6366f1",
      cancelButtonColor: "#6b7280",
    });

    if (result.isConfirmed) {
      const newMode = currentMode === 'realtime' ? 'manual' : 'realtime';
      await saveUserPreference(newMode);
      setMode(newMode);
      
      Swal.fire({
        icon: "success",
        title: "Mode Switched!",
        text: `Now using ${newMode === 'realtime' ? 'Realtime' : 'Manual'} tracking`,
        timer: 1500,
        showConfirmButton: false,
      });
    }
  };

  // ------------------ Realtime Tracking Functions ------------------
  function updateRealtimeDate() {
    const now = new Date();
    document.getElementById("realtimeDate").textContent = formatDate(now.toISOString().split('T')[0]);
  }

  function formatElapsedTime(milliseconds) {
    const totalSeconds = Math.floor(milliseconds / 1000);
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;
    
    return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
  }

  window.startRealtime = function() {
    realtimeStartTime = Date.now();
    realtimeStartDate = new Date().toISOString().split('T')[0];
    
    document.getElementById("startBtn").disabled = true;
    document.getElementById("stopBtn").disabled = false;
    document.getElementById("stopBtn").classList.add("pulse-glow");
    
    realtimeInterval = setInterval(() => {
      const elapsed = Date.now() - realtimeStartTime;
      document.getElementById("realtimeDisplay").textContent = formatElapsedTime(elapsed);
    }, 1000);
    
    Swal.fire({
      icon: "success",
      title: "Timer Started!",
      text: "Tracking your time now",
      timer: 1500,
      showConfirmButton: false,
    });
  };

  window.stopRealtime = async function() {
    if (!realtimeStartTime) return;
    
    clearInterval(realtimeInterval);
    const endTime = Date.now();
    const elapsed = endTime - realtimeStartTime;
    
    const startDate = new Date(realtimeStartTime);
    const endDate = new Date(endTime);
    
    const startTimeStr = startDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
    const endTimeStr = endDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
    
    const diffMinutes = Math.floor(elapsed / 60000);
    const note = document.getElementById("realtimeNote").value.trim();
    
    const newEntry = {
      date: realtimeStartDate,
      start: startTimeStr,
      end: endTimeStr,
      hours: Math.floor(diffMinutes / 60),
      minutes: diffMinutes % 60,
      minutesTotal: diffMinutes,
      note: note || "",
      uid: user.uid,
    };

    try {
      const docRef = await addDoc(timeCollection, newEntry);
      newEntry.id = docRef.id;
      allEntries.push(newEntry);

      filterThisMonthEntries();

      Swal.fire({
        icon: "success",
        title: "Time Saved!",
        html: `<p class="text-lg">Duration: <strong>${newEntry.hours}h ${newEntry.minutes}m</strong></p>`,
        timer: 2000,
        showConfirmButton: false,
      });

      // Reset
      document.getElementById("realtimeDisplay").textContent = "00:00:00";
      document.getElementById("realtimeNote").value = "";
      document.getElementById("startBtn").disabled = false;
      document.getElementById("stopBtn").disabled = true;
      document.getElementById("stopBtn").classList.remove("pulse-glow");
      realtimeStartTime = null;
      realtimeStartDate = null;
      
    } catch (error) {
      Swal.fire({
        icon: "error",
        title: "Failed to save entry",
        text: error.message,
      });
    }
  };

  // ------------------ Note Modal Functions ------------------
  window.viewNote = function(index) {
    const entry = entries[index];
    document.getElementById("noteModalDate").textContent = formatDate(entry.date);
    document.getElementById("noteModalTime").textContent = `${formatTime(entry.start)} - ${formatTime(entry.end)}`;
    document.getElementById("noteModalDuration").textContent = `${entry.hours}h ${entry.minutes}m`;
    document.getElementById("noteModalContent").textContent = entry.note || "No note added for this entry.";
    document.getElementById("noteModal").classList.remove("hidden");
  };

  window.closeNoteModal = function() {
    document.getElementById("noteModal").classList.add("hidden");
  };

  // ------------------ Add Entry Modal Functions ------------------
  let modalStartPicker, modalEndPicker;

  window.openAddEntryModal = function() {
    document.getElementById("addEntryModal").classList.remove("hidden");
    document.getElementById("modalDate").valueAsDate = new Date();
    
    // Initialize Flatpickr for modal inputs if not already initialized
    if (!modalStartPicker) {
      modalStartPicker = flatpickr("#modalStart", {
        enableTime: true,
        noCalendar: true,
        dateFormat: "h:i K",
        time_24hr: false,
        defaultDate: new Date(),
        minuteIncrement: 15,
      });
    }
    
    if (!modalEndPicker) {
      modalEndPicker = flatpickr("#modalEnd", {
        enableTime: true,
        noCalendar: true,
        dateFormat: "h:i K",
        time_24hr: false,
        defaultDate: new Date(new Date().getTime() + 60 * 60 * 1000),
        minuteIncrement: 15,
      });
    }
    
    // Reset to current times
    modalStartPicker.setDate(new Date(), true);
    modalEndPicker.setDate(new Date(new Date().getTime() + 60 * 60 * 1000), true);
    document.getElementById("modalNote").value = "";
  };

  window.closeAddEntryModal = function() {
    document.getElementById("addEntryModal").classList.add("hidden");
  };

  window.saveManualEntry = async function() {
    const date = document.getElementById("modalDate").value;
    const start = document.getElementById("modalStart").value;
    const end = document.getElementById("modalEnd").value;
    const note = document.getElementById("modalNote").value.trim();

    if (!date || !start || !end) {
      Swal.fire({ icon: "error", title: "Missing Fields", text: "Please fill in date, start time, and end time" });
      return;
    }

    const startTime = new Date(`${date} ${start}`);
    const endTime = new Date(`${date} ${end}`);
    if (endTime <= startTime) {
      Swal.fire({ icon: "warning", title: "Invalid Time Range", text: "End time must be after start time" });
      return;
    }

    const diffMinutes = Math.floor((endTime - startTime) / 60000);

    const newEntry = {
      date,
      start,
      end,
      hours: Math.floor(diffMinutes / 60),
      minutes: diffMinutes % 60,
      minutesTotal: diffMinutes,
      note: note || "",
      uid: user.uid,
    };

    try {
      const docRef = await addDoc(timeCollection, newEntry);
      newEntry.id = docRef.id;
      allEntries.push(newEntry);

      filterThisMonthEntries();

      closeAddEntryModal();

      Swal.fire({
        icon: "success",
        title: "Time Added!",
        timer: 1200,
        showConfirmButton: false,
      });
    } catch (error) {
      Swal.fire({
        icon: "error",
        title: "Failed to save entry",
        text: error.message,
      });
    }
  };

  // ------------------ History Modal Functions ------------------
  window.openHistoryModal = function() {
    document.getElementById("historyModal").classList.remove("hidden");
    historyEntries = [...allEntries];
    populateModalYearFilter();
    refreshHistoryModal();
  };

  window.closeHistoryModal = function() {
    document.getElementById("historyModal").classList.add("hidden");
    document.getElementById("modalFilterMonth").value = "";
    document.getElementById("modalFilterYear").value = "";
  };

  function populateModalYearFilter() {
    const years = [...new Set(allEntries.map(e => new Date(e.date).getFullYear()))].sort((a, b) => b - a);
    const yearSelect = document.getElementById("modalFilterYear");
    yearSelect.innerHTML = '<option value="">All Years</option>';
    years.forEach(year => {
      const option = document.createElement("option");
      option.value = year;
      option.textContent = year;
      yearSelect.appendChild(option);
    });
  }

  function refreshHistoryModal() {
    const historyList = document.getElementById("historyList");
    historyList.innerHTML = "";
    
    if (historyEntries.length === 0) {
      historyList.innerHTML = `
        <tr>
          <td colspan="5" class="p-12 text-center text-gray-400">
            <i class="fa-solid fa-clock text-6xl mb-4 block text-indigo-200"></i>
            <p class="text-xl font-semibold text-gray-500">No entries found</p>
            <p class="text-sm text-gray-400 mt-2">Try adjusting your filters</p>
          </td>
        </tr>
      `;
      document.getElementById("historyTotal").textContent = "0h 0m";
      return;
    }

    historyEntries.forEach(entry => {
      const noteDisplay = entry.note ? `<span class="text-gray-600 italic">${entry.note}</span>` : `<span class="text-gray-400 italic">No note</span>`;
      const row = `
        <tr class="hover:bg-gradient-to-r hover:from-indigo-50 hover:to-purple-50 transition-all duration-200">
          <td class="p-5 text-gray-700 font-medium">${formatDate(entry.date)}</td>
          <td class="p-5 text-gray-600">${formatTime(entry.start)}</td>
          <td class="p-5 text-gray-600">${formatTime(entry.end)}</td>
          <td class="p-5 font-bold text-lg bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">${entry.hours}h ${entry.minutes}m</td>
          <td class="p-5">${noteDisplay}</td>
        </tr>
      `;
      historyList.insertAdjacentHTML("beforeend", row);
    });

    const historyTotal = historyEntries.reduce((sum, entry) => sum + entry.minutesTotal, 0);
    const h = Math.floor(historyTotal / 60);
    const m = historyTotal % 60;
    document.getElementById("historyTotal").textContent = `${h}h ${m}m`;
  }

  window.applyModalFilter = function() {
    historyEntries = [...allEntries];
    
    const filterMonth = document.getElementById("modalFilterMonth").value;
    const filterYear = document.getElementById("modalFilterYear").value;
    
    if (filterMonth !== "") {
      historyEntries = historyEntries.filter(entry => {
        const entryDate = new Date(entry.date);
        return entryDate.getMonth() === parseInt(filterMonth);
      });
    }
    
    if (filterYear !== "") {
      historyEntries = historyEntries.filter(entry => {
        const entryDate = new Date(entry.date);
        return entryDate.getFullYear() === parseInt(filterYear);
      });
    }
    
    refreshHistoryModal();
  };

  window.clearModalFilter = function() {
    document.getElementById("modalFilterMonth").value = "";
    document.getElementById("modalFilterYear").value = "";
    historyEntries = [...allEntries];
    refreshHistoryModal();
  };

  window.exportHistoryToCSV = function() {
    if (historyEntries.length === 0) {
      Swal.fire({ icon: "info", title: "No entries to export" });
      return;
    }

    const csvRows = [];
    csvRows.push("Date,Start Time,End Time,Duration (Hours),Duration (Minutes),Note");

    historyEntries.forEach(entry => {
      const row = [
        formatDate(entry.date),
        formatTime(entry.start),
        formatTime(entry.end),
        entry.hours,
        entry.minutes,
        `"${(entry.note || "").replace(/"/g, '""')}"`
      ].join(",");
      csvRows.push(row);
    });

    const csvContent = csvRows.join("\n");
    const blob = new Blob([csvContent], { type: "text/csv" });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `time-tracker-history-${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    window.URL.revokeObjectURL(url);

    Swal.fire({
      icon: "success",
      title: "Exported!",
      text: "Your time entries have been exported to CSV",
      timer: 2000,
      showConfirmButton: false,
    });
  };

  // ------------------ Export This Month to CSV ------------------
  window.exportToCSV = function() {
    if (entries.length === 0) {
      Swal.fire({ icon: "info", title: "No entries to export" });
      return;
    }

    const csvRows = [];
    csvRows.push("Date,Start Time,End Time,Duration (Hours),Duration (Minutes),Note");

    entries.forEach(entry => {
      const row = [
        formatDate(entry.date),
        formatTime(entry.start),
        formatTime(entry.end),
        entry.hours,
        entry.minutes,
        `"${(entry.note || "").replace(/"/g, '""')}"`
      ].join(",");
      csvRows.push(row);
    });

    const csvContent = csvRows.join("\n");
    const blob = new Blob([csvContent], { type: "text/csv" });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `time-tracker-this-month-${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    window.URL.revokeObjectURL(url);

    Swal.fire({
      icon: "success",
      title: "Exported!",
      text: "Your time entries have been exported to CSV",
      timer: 2000,
      showConfirmButton: false,
    });
  };

  // ------------------ Sorting Logic ------------------
  let sortField = null;
  let sortAsc = true;

  function sortEntries(field) {
    if (sortField === field) sortAsc = !sortAsc;
    else {
      sortField = field;
      sortAsc = true;
    }

    entries.sort((a, b) => {
      let valA, valB;

      switch (field) {
        case "date":
          valA = new Date(a.date);
          valB = new Date(b.date);
          break;
        case "start":
          valA = new Date(`${a.date} ${a.start}`);
          valB = new Date(`${b.date} ${b.start}`);
          break;
        case "end":
          valA = new Date(`${a.date} ${a.end}`);
          valB = new Date(`${b.date} ${b.end}`);
          break;
        case "duration":
          valA = a.minutesTotal;
          valB = b.minutesTotal;
          break;
        default:
          valA = 0;
          valB = 0;
      }

      return sortAsc ? valA - valB : valB - valA;
    });

    refreshTable();
  }

  // ------------------ Delete Functions ------------------

  window.deleteEntry = async function (index) {
    const entry = entries[index];
    const result = await Swal.fire({
      title: "Are you sure you want to delete this entry?",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#dc2626",
      cancelButtonColor: "#6b7280",
      confirmButtonText: "Yes, delete",
      cancelButtonText: "Cancel",
    });

    if (!result.isConfirmed) return;

    try {
      await deleteDoc(doc(db, "timeEntries", entry.id));
      
      allEntries = allEntries.filter(e => e.id !== entry.id);
      entries.splice(index, 1);
      totalMinutes -= entry.minutesTotal;
      
      refreshTable();
      updateTotal();
      Swal.fire({ icon: "success", title: "Deleted!", timer: 1000, showConfirmButton: false });
    } catch (error) {
      Swal.fire({ icon: "error", title: "Failed to delete", text: error.message });
    }
  };

  window.deleteAllEntries = async function () {
    if (entries.length === 0) {
      Swal.fire({ icon: "info", title: "No entries to delete" });
      return;
    }

    const result = await Swal.fire({
      title: "Delete ALL entries?",
      text: "This action cannot be undone!",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#dc2626",
      cancelButtonColor: "#6b7280",
      confirmButtonText: "Yes, delete all",
      cancelButtonText: "Cancel",
    });

    if (!result.isConfirmed) return;

    try {
      const batch = writeBatch(db);
      entries.forEach((entry) => batch.delete(doc(db, "timeEntries", entry.id)));
      await batch.commit();
      
      const deletedIds = entries.map(e => e.id);
      allEntries = allEntries.filter(e => !deletedIds.includes(e.id));
      
      entries = [];
      totalMinutes = 0;
      refreshTable();
      updateTotal();

      Swal.fire({ icon: "success", title: "All entries deleted", timer: 1200, showConfirmButton: false });
    } catch (error) {
      Swal.fire({ icon: "error", title: "Failed to delete all", text: error.message });
    }
  };

  window.logoutUser = function () {
    Swal.fire({
      title: "Are you sure you want to logout?",
      icon: "question",
      showCancelButton: true,
      confirmButtonColor: "#dc2626",
      cancelButtonColor: "#6b7280",
      confirmButtonText: "Yes, logout",
      cancelButtonText: "Cancel",
    }).then((result) => {
      if (result.isConfirmed) {
        signOut(auth)
          .then(() => Swal.fire({ icon: "success", title: "Logged out", timer: 1000, showConfirmButton: false })
            .then(() => (window.location.href = "index.html")))
          .catch((error) => Swal.fire({ icon: "error", title: "Logout Failed", text: error.message }));
      }
    });
  };

  onAuthStateChanged(auth, (u) => {
    if (u) {
      user = u;
      showLoading();
      loadFromFirestore().then(() => {
        loadUserPreference();
      });
    } else {
      Swal.fire({
        icon: "warning",
        title: "You must log in first!",
        timer: 1500,
        showConfirmButton: false,
      }).then(() => (window.location.href = "index.html"));
    }
  });

  document.querySelectorAll("th").forEach((th) => {
    const fieldMap = { Date: "date", Start: "start", End: "end", Duration: "duration" };
    const field = fieldMap[th.textContent.trim()];
    if (field) {
      th.style.cursor = "pointer";
      th.addEventListener("click", () => sortEntries(field));
    }
  });

  function showLoading() {
    document.getElementById("loading").classList.remove("hidden");
  }

  function hideLoading() {
    document.getElementById("loading").classList.add("hidden");
  }

</script>

<!-- Loading Overlay -->
<div
  id="loading"
  class="fixed inset-0 bg-gradient-to-br from-indigo-900/95 via-purple-900/95 to-pink-900/95 backdrop-blur-lg z-[9999] hidden flex items-center justify-center"
>
  <div class="flex flex-col items-center gap-6 bg-white/10 backdrop-blur-xl p-12 rounded-3xl border border-white/20 shadow-2xl">
    <i class="fa-solid fa-spinner fa-spin text-white text-6xl"></i>
    <span class="text-white font-bold text-2xl animate-pulse">Loading time entries...</span>
  </div>
</div>

  </body>
</html>